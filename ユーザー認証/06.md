# ユーザー認証を作成する 05 (VaadinWebSecurity)

本項では、データベースと連携した認証機能の実装を行う。前項まではインメモリ認証で、`SecurityConfig`内で設定したユーザでのログインを行っていた。<br>

今回は、データベースに登録されたユーザの情報と、サインイン用のフォームに入力された情報を照合しユーザ認証を行うための実装をしていく。

### `authorities` テーブルの作成

まず、DB認証を行うにあたって、今回は`USER`,`ADMIN`の2つのロールを想定して新たなテーブルを作成する。<br>

以下の`sql`を実行しよう。

```sql
drop table if exists auth_user;
drop table if exists authorities;

create table auth_user(
    user_name varchar(255) primary key ,
    user_pass varchar(255) not null
);

create table authorities(
    user_name varchar(255) primary key ,
    user_roles varchar(255) not null ,
    foreign key (user_name) references auth_user (user_name)
    ON DELETE CASCADE
    ON UPDATE CASCADE
);

insert into auth_user values ('exampleadmin', 'exampleadmin'), ('exampleuser', 'exampleuser');
insert into authorities values ('exampleadmin', 'ROLE_ADMIN'), ('exampleuser', 'ROLE_USER');
```

上記のSQLでは、既に作成されている`auth_user`テーブル、`authorities`テーブルがある場合、そのテーブルを削除したうえでテスト用のデータを作成している。
- `primary key`　日本語では主キーと呼ばれる。この列は他の列を一意に従属させるキーで、様々な制約がついている。

- `not null`　必ず存在しないといけないという意味の列制約

- `foreign key (this_table_column_name) references table_name (foreign_teble_column_name)`

  - このテーブルにあるある列を外部キー(他のテーブルのキーを参照するキー)として設定する。今回の例では、`authorities`テーブルの`user_name`列が`auth_user`テーブルの`user_name`列を参照するように設定している。外部キーを設定すると、その列に関していくつかの制約を設けることができる。

  - `ON DELETE CASCADE`　外部キー列が参照する親テーブルの外部キー列が削除されると、子の外部キー列も削除される。

  - `ON UPDATE CASCADE`　上記と同じ原理で、参照先(親)の外部キー列が変更されると、子の外部キー列も同じ内容に更新される。

これにより、DB認証のためのテーブル作成が完了する。


### 